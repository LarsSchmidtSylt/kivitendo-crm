<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />

<?php
    require_once("inc/stdLib.php");
    $menu = $_SESSION['menu'];
    $head = mkHeader();
    echo $menu['stylesheets'];
    echo $menu['javascripts'];
    //echo $head['FULLCALCSS'];
    //echo $head['BOXCSS'];
    //echo $head['COLORPICKERCSS'];
    echo $head['JQUERY'];
    echo $head['JQUERYUI'];
    echo $head['THEME'];
    echo $head['TINYMCE'];
    //echo $head['JQBOX'];
    //echo $head['COLORPICKERJS'];
    //print_r( $_SESSION );


?>

<script>

  $(document).ready(function(){

  tinymce.init({
  selector: 'h2.editable',
  inline: true,
  toolbar: 'undo redo',
  menubar: false
});

tinymce.init({
  selector: 'div.editable',
  inline: true,
  plugins: [
    'save advlist autolink lists link image charmap print preview anchor',
    'searchreplace visualblocks code fullscreen',
    'insertdatetime media table contextmenu paste'
  ],
  toolbar: 'undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image'
});

      var category_id;
         
      $.ajax({
            dataType: "json",
            url: "ajax/knowledge.php?action=getCategories",
            method: "GET",
            success: function( json ) {
               var obj = JSON.parse( json.trim() );
                //console.log( JSON.stringify( obj ) );
                $.each( obj[0].maingroup, function( i, val ){

                    $( "#menu" ).append("<li id='main_" + val.id + "'>" + val.labeltext + "</li>"  );
     
                });
                $.each( obj[1].undergroup, function( i, val ){
                    if( !$('#main_'  + val.maingroup + ' ul').length > 0 ){
                        $( '#main_' + val.maingroup ).append( "<ul id='ul" + val.maingroup + "'></ul>" );
                    }   
                    $( "#ul" + val.maingroup  ).append("<li id='msub_" + val.id + "'>" + val.labeltext + "</li>" );
     
                });
                $( '#menu' ).menu();
                $( '[id^=main_]' ).on( 'click', function(event) {
                    //console.log( event.target.id.substring( 5 ) );                    
                    //alert(event.target.id.substring( 5 ))
                    category_id = event.target.id.substring( 5 );
                    $.ajax({
                        dataType: "json",
                        url: "ajax/knowledge.php?action=getArticle&data=" + category_id,
                        method: "GET",
                        success: function( json ) {
                            var obj = JSON.parse( json.trim() );
                            //alert(JSON.stringify( obj[0].content )  );
                            //console.log( JSON.stringify( obj ) );
                            $('#read').html(obj[0].content);
                            
                        }
                    })
                });
            },
            error: function () {
                alert('Ajax Error');
            }
    });

    $("#last").button({label:"last"});

    $("#save").button({label:"save"}).click(function (event) {
        var artContent = encodeURIComponent( $("#read").html() );
        var data = category_id + "___" + artContent;
        $.ajax({
           dataType: "json",
           url: "ajax/knowledge.php?action=updateContent&data=" + data,
           method: "GET",
           success: function( json ) {
                   //alert(JSON.stringify(json));
           },
           error: function () {
                alert('Ajax Error');
           }

        })
    });

    $("#nextvers").button({label:"nextversion"}).click(function (event) {
        var artContent = encodeURIComponent( $("#read").html() );
        var data = category_id + "___" + artContent;
        $.ajax({
           dataType: "json",
           url: "ajax/knowledge.php?action=nextVersion&data=" + data,
           method: "GET",
           success: function( json ) {
                   alert(JSON.stringify(json));
           },
           error: function () {
                alert('Ajax Error');
           }

        })
    });

});

</script>
<style>
.ui-menu { width: 180px; }

#read{   position:absolute; top:55px; left:220px; width: 80%; background-color:#dfd; border:1px solid #888; }
#write{  position:absolute; top:60px; left:220px; width: 80%; background-color:#dfe; border:1px solid #666; }
</style>    

</head>
<body>
<?php 
    echo $menu['pre_content'];
    echo $menu['start_content'];
?>
<div class="ui-widget-content" style="height:600px">

    <ul id="menu"></ul>
    <p><button id="last"></button></p>
    <p><button id="save"></button></p>
    <p><button id="nextvers"></button></p>
    <div id="read" class="editable"></div>

</div>
<?php echo $menu['end_content']; ?>
</body>
</html>